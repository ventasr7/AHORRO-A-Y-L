<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retroceso / Desperdicio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f1f5f9;
            font-family: 'Inter', sans-serif;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        select, input {
            border: 1px solid #cbd5e1;
            padding: 0.75rem;
            border-radius: 8px;
            width: 100%;
        }
        .btn-delete {
            background-color: #fee2e2;
            color: #dc2626;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .btn-delete:hover {
            background-color: #dc2626;
            color: white;
        }
        .tipo-badge {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
        }
        .bg-desperdicio { background-color: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
        .bg-reproceso { background-color: #fffbeb; color: #92400e; border: 1px solid #fef3c7; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto">
        <header class="mb-8 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-black text-slate-800 uppercase tracking-tighter italic">RETROCESO / DESPERDICIO</h1>
                <p class="text-slate-500 font-medium">Panel de control de producción</p>
            </div>
            <div class="text-right">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Sumatoria Total</p>
                <p id="totalSumatoria" class="text-4xl font-black text-blue-600">0</p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Formulario -->
            <div class="lg:col-span-1">
                <div class="card p-6 border-t-4 border-blue-600">
                    <form id="registroForm" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Categoría</label>
                            <select id="inputTipo" required class="font-bold">
                                <option value="DESPERDICIO">DESPERDICIO</option>
                                <option value="REPROCESO">REPROCESO</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fecha de Registro</label>
                            <input type="date" id="inputFecha" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cantidad Original</label>
                            <input type="number" id="inputCantidad" step="any" placeholder="0.00" required class="text-lg font-bold">
                            <p class="text-[10px] text-blue-500 mt-1 font-bold italic">* Automáticamente se restarán 20</p>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tanda</label>
                                <select id="inputTanda" required>
                                    <option value="C-1">C-1</option><option value="C-2">C-2</option><option value="C-3">C-3</option>
                                    <option value="A-1">A-1</option><option value="A-2">A-2</option><option value="A-3">A-3</option>
                                    <option value="B-1">B-1</option><option value="B-2">B-2</option><option value="B-3">B-3</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Línea</label>
                                <select id="inputLinea" required>
                                    <option value="LPL01">LPL01</option><option value="LPL02">LPL02</option>
                                    <option value="LFI01">LFI01</option><option value="LFI02">LFI02</option>
                                    <option value="LPC02">LPC02</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-slate-800 text-white font-bold py-3 rounded-lg hover:bg-black transition-all uppercase text-sm tracking-widest">
                            Guardar Registro
                        </button>
                    </form>
                </div>
            </div>

            <!-- Tabla -->
            <div class="lg:col-span-2">
                <div class="card overflow-hidden">
                    <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                        <h2 class="font-bold text-slate-700 text-sm uppercase">Historial Almacenado</h2>
                        <button onclick="borrarTodo()" class="text-[10px] font-bold text-red-600 border border-red-200 px-2 py-1 rounded hover:bg-red-50 uppercase">Borrar Todo</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-slate-50 text-[10px] uppercase text-slate-400 border-b">
                                    <th class="px-4 py-3">Fecha / Tipo</th>
                                    <th class="px-4 py-3">Cantidad (-20)</th>
                                    <th class="px-4 py-3">Tanda/Línea</th>
                                    <th class="px-4 py-3 text-center">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="tablaCuerpo" class="divide-y divide-slate-100">
                                <!-- Filas -->
                            </tbody>
                        </table>
                    </div>
                    <div id="mensajeVacio" class="p-12 text-center text-slate-300 italic hidden">
                        No hay registros guardados.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Cargar datos guardados
        let registros = JSON.parse(localStorage.getItem('db_planta')) || [];

        const form = document.getElementById('registroForm');
        const tabla = document.getElementById('tablaCuerpo');
        const totalEl = document.getElementById('totalSumatoria');
        const msgVacio = document.getElementById('mensajeVacio');

        // Configurar fecha de hoy
        window.onload = () => {
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('inputFecha').value = hoy;
            renderizar();
        };

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const fechaVal = document.getElementById('inputFecha').value;
            const cantOri = parseFloat(document.getElementById('inputCantidad').value);
            const tipo = document.getElementById('inputTipo').value;
            const tanda = document.getElementById('inputTanda').value;
            const linea = document.getElementById('inputLinea').value;

            // Lógica de cálculo
            const cantFinal = cantOri - 20;

            // Formatear fecha
            const fObj = new Date(fechaVal + 'T00:00:00');
            const diaNom = fObj.toLocaleDateString('es-ES', { weekday: 'short' });
            const fechaFormat = fObj.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });

            const nuevo = {
                id: Date.now(),
                tipo,
                dia: diaNom.toUpperCase(),
                fecha: fechaFormat,
                cantidad: cantFinal,
                tanda,
                linea
            };

            registros.unshift(nuevo);
            guardar();
            form.reset();
            window.onload(); // Reset fecha y foco
            document.getElementById('inputCantidad').focus();
        });

        function guardar() {
            localStorage.setItem('db_planta', JSON.stringify(registros));
            renderizar();
        }

        // FUNCIÓN PARA ELIMINAR INDIVIDUAL
        function eliminar(id) {
            if (confirm("¿Seguro que quieres eliminar este registro?")) {
                registros = registros.filter(r => r.id !== id);
                guardar();
            }
        }

        function borrarTodo() {
            if (confirm("¿BORRAR TODO EL HISTORIAL? Esta acción no se puede deshacer.")) {
                registros = [];
                guardar();
            }
        }

        function renderizar() {
            tabla.innerHTML = '';
            let suma = 0;

            if (registros.length === 0) {
                msgVacio.classList.remove('hidden');
            } else {
                msgVacio.classList.add('hidden');
            }

            registros.forEach(r => {
                suma += r.cantidad;
                const claseTipo = r.tipo === 'DESPERDICIO' ? 'bg-desperdicio' : 'bg-reproceso';
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-4 py-4">
                        <span class="tipo-badge ${claseTipo}">${r.tipo}</span>
                        <div class="text-[10px] font-bold text-slate-500 mt-1">${r.dia} ${r.fecha}</div>
                    </td>
                    <td class="px-4 py-4 font-black text-slate-800 text-lg">${r.cantidad.toLocaleString()}</td>
                    <td class="px-4 py-4">
                        <div class="flex flex-col gap-1">
                            <span class="text-[9px] font-bold text-blue-600 bg-blue-50 px-1 rounded w-fit">TANDA: ${r.tanda}</span>
                            <span class="text-[9px] font-bold text-slate-600 bg-slate-100 px-1 rounded w-fit">LÍNEA: ${r.linea}</span>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <button onclick="eliminar(${r.id})" class="btn-delete" title="Eliminar registro">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                `;
                tabla.appendChild(tr);
            });

            totalEl.innerText = suma.toLocaleString();
        }
    </script>
</body>
</html>

