<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guerra de Apuestas VS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #F9FAFB; /* text-gray-50 */
        }
        .team-shadow-blue {
            box-shadow: 0 0 15px 5px rgba(59, 130, 246, 0.6);
        }
        .team-shadow-red {
            box-shadow: 0 0 15px 5px rgba(239, 68, 68, 0.6);
        }
        .progress-bar-animated {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .registro-item {
            transition: all 0.3s ease;
            border-left-width: 4px;
        }
        .registro-item:hover {
            transform: translateX(5px);
            background-color: #374151; /* bg-gray-700 */
        }
        #modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        #modal-content {
            transition: transform 0.3s ease-in-out;
        }
        /* Team Theming for Game View */
        #game-view.team-blue {
            background: radial-gradient(ellipse at top, #1e3a8a 0%, #111827 60%);
        }
        #game-view.team-red {
            background: radial-gradient(ellipse at top, #991b1b 0%, #111827 60%);
        }
        #game-view.team-blue .themed-header {
            color: #93c5fd; /* blue-300 */
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        #game-view.team-red .themed-header {
            color: #fca5a5; /* red-300 */
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Vista de Selección de Equipo (Inicial) -->
    <div id="selection-view" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="text-center w-full max-w-md">
            <h1 class="text-4xl md:text-5xl font-black uppercase tracking-wider text-white">Guerra de Apuestas</h1>
            <p class="text-xl font-bold text-gray-300 mt-2">Meta: <span class="text-yellow-400">100,000</span></p>
            <div class="mt-8">
                <input type="text" id="name-input" placeholder="Escribe tu nombre de jugador" class="w-full px-4 py-3 bg-gray-800 border-2 border-gray-700 rounded-lg text-lg text-center text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <p class="mt-6 text-lg font-medium text-gray-400">Elige tu equipo</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <button id="select-blue" class="w-full py-4 bg-blue-600 rounded-lg text-xl font-bold uppercase hover:bg-blue-700 transition-colors duration-300 team-shadow-blue">
                    Equipo Azul
                </button>
                <button id="select-red" class="w-full py-4 bg-red-600 rounded-lg text-xl font-bold uppercase hover:bg-red-700 transition-colors duration-300 team-shadow-red">
                    Equipo Rojo
                </button>
            </div>
        </div>
    </div>

    <!-- Vista Principal del Juego -->
    <div id="game-view" class="hidden min-h-screen p-4 md:p-8">
        <div class="max-w-4xl mx-auto">
            <!-- Cabecera y Totales -->
            <div class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-black uppercase tracking-wider themed-header">Marcador General</h1>
                <p class="text-lg font-bold text-gray-300 mt-1">Meta: <span class="text-yellow-400">100,000</span></p>
            </div>

            <!-- Barras de Progreso -->
            <div class="space-y-4">
                <!-- Barra Azul -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-lg font-bold text-blue-400">EQUIPO AZUL</span>
                        <span id="total-blue-text" class="text-lg font-semibold text-white">0</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-8 overflow-hidden border-2 border-blue-500">
                        <div id="progress-blue" class="bg-blue-600 h-full rounded-full progress-bar-animated flex items-center justify-center text-sm font-bold" style="width: 0%;">0%</div>
                    </div>
                </div>
                <!-- Barra Roja -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-lg font-bold text-red-400">EQUIPO ROJO</span>
                        <span id="total-red-text" class="text-lg font-semibold text-white">0</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-8 overflow-hidden border-2 border-red-500">
                        <div id="progress-red" class="bg-red-600 h-full rounded-full progress-bar-animated flex items-center justify-center text-sm font-bold" style="width: 0%;">0%</div>
                    </div>
                </div>
            </div>

            <!-- Área de Ingreso de Apuesta -->
            <div class="mt-10 p-6 bg-gray-800 rounded-2xl border border-gray-700 shadow-lg">
                <div id="welcome-message" class="text-center text-xl font-semibold mb-4"></div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="number" id="amount-input" placeholder="Cantidad a apostar" class="flex-grow px-4 py-3 bg-gray-900 border-2 border-gray-600 rounded-lg text-lg text-center text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <button id="save-button" class="w-full sm:w-auto px-8 py-3 bg-green-600 rounded-lg text-lg font-bold uppercase hover:bg-green-700 transition-colors duration-300">Aportar</button>
                </div>
            </div>

            <!-- Historial de Registros -->
            <div class="mt-10">
                <h3 class="text-2xl font-bold text-center mb-4">Historial de Apuestas</h3>
                <div id="registros-container" class="space-y-3 bg-gray-800 p-4 rounded-lg border border-gray-700 max-h-96 overflow-y-auto">
                    <!-- Los registros se insertarán aquí -->
                </div>
            </div>
             <div class="text-center mt-4">
                <p class="text-sm text-gray-500">Tu ID de Jugador (para compartir):</p>
                <p id="user-id-display" class="text-md text-gray-400 font-mono select-all break-all"></p>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmación para Eliminar -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="modal-backdrop" class="absolute inset-0 bg-black bg-opacity-70"></div>
        <div id="modal-content" class="relative w-full max-w-md bg-gray-800 rounded-2xl p-6 border border-gray-600 transform scale-95">
            <h3 class="text-xl font-bold mb-4">Confirmar Eliminación</h3>
            <p id="modal-text" class="text-gray-300 mb-6">¿Estás seguro?</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-delete" class="px-6 py-2 bg-gray-600 rounded-lg font-semibold hover:bg-gray-700 transition">Cancelar</button>
                <button id="confirm-delete" class="px-6 py-2 bg-red-600 rounded-lg font-semibold hover:bg-red-700 transition">Eliminar</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, orderBy, deleteDoc, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- CONFIGURACIÓN Y VARIABLES GLOBALES ---
        
        // Usar variables globales para la configuración si están disponibles
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Inserta aquí tu configuración de Firebase si no usas el entorno Canvas
            apiKey: "AIza...",
            authDomain: "...",
            projectId: "...",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "..."
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-vs-app';

        // Inicialización de Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // setLogLevel('debug'); // Descomentar para ver logs detallados de Firestore
        
        const META = 100000;
        let currentUser = null;

        // Elementos del DOM
        const selectionView = document.getElementById('selection-view');
        const gameView = document.getElementById('game-view');
        const nameInput = document.getElementById('name-input');
        const selectBlueBtn = document.getElementById('select-blue');
        const selectRedBtn = document.getElementById('select-red');
        const progressBlue = document.getElementById('progress-blue');
        const progressRed = document.getElementById('progress-red');
        const totalBlueText = document.getElementById('total-blue-text');
        const totalRedText = document.getElementById('total-red-text');
        const welcomeMessage = document.getElementById('welcome-message');
        const amountInput = document.getElementById('amount-input');
        const saveButton = document.getElementById('save-button');
        const registrosContainer = document.getElementById('registros-container');
        const userIdDisplay = document.getElementById('user-id-display');
        
        // Elementos del Modal
        const modal = document.getElementById('confirmation-modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');
        const modalText = document.getElementById('modal-text');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const confirmDeleteBtn = document.getElementById('confirm-delete');

        // --- LÓGICA DE AUTENTICACIÓN ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Usuario ha iniciado sesión
                const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    currentUser = { uid: user.uid, ...userDoc.data() };
                    userIdDisplay.textContent = user.uid;
                    setupGameView();
                } else {
                    // El usuario está autenticado pero no tiene datos en Firestore, debería estar en la pantalla de selección.
                    showSelectionView();
                }
            } else {
                 // No hay usuario, intentar iniciar sesión anónima o con token
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (error) {
                        console.error("Error signing in with custom token, falling back to anonymous", error);
                        await signInAnonymously(auth);
                    }
                } else {
                    // Si no hay usuario ni token, mostramos la pantalla de selección para que se registre al elegir equipo
                    showSelectionView();
                }
            }
        });

        // --- MANEJO DE VISTAS ---

        function showSelectionView() {
            gameView.classList.add('hidden');
            selectionView.classList.remove('hidden');
        }

        function showGameView() {
            selectionView.classList.add('hidden');
            gameView.classList.remove('hidden');
        }

        function setupGameView() {
            // Theme the game view based on the team
            gameView.classList.remove('team-blue', 'team-red');
            const teamThemeClass = currentUser.team === 'AZUL' ? 'team-blue' : 'team-red';
            gameView.classList.add(teamThemeClass);

            let teamColorClass = currentUser.team === 'AZUL' ? 'text-blue-400' : 'text-red-400';
            welcomeMessage.innerHTML = `Aportando para <span class="${teamColorClass} font-bold">${currentUser.name}</span>`;
            showGameView();
            listenToTotals();
            listenToRegistros();
        }


        // --- LÓGICA DE SELECCIÓN DE EQUIPO ---

        const handleTeamSelection = async (team) => {
            const name = nameInput.value.trim();
            if (!name) {
                // Reemplazamos alert() con un borde rojo para mejor UX
                nameInput.classList.add('border-red-500', 'ring-red-500');
                nameInput.placeholder = '¡Tu nombre es obligatorio!';
                setTimeout(() => {
                    nameInput.classList.remove('border-red-500', 'ring-red-500');
                    nameInput.placeholder = 'Escribe tu nombre de jugador';
                }, 2500);
                return;
            }

            try {
                let user = auth.currentUser;
                if (!user) {
                     const userCredential = await signInAnonymously(auth);
                     user = userCredential.user;
                }
               
                const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid);
                const userData = { name: name, team: team };

                await setDoc(userDocRef, userData);

                // --- CAMBIO CLAVE ---
                // Forzamos la actualización de la vista directamente aquí
                // en lugar de esperar al listener onAuthStateChanged.
                currentUser = { uid: user.uid, ...userData };
                userIdDisplay.textContent = user.uid;
                setupGameView(); // Esto soluciona el problema de la transición

            } catch (error) {
                console.error("Error al seleccionar equipo: ", error);
                // Aquí podríamos mostrar un modal de error en lugar de un alert.
            }
        };

        selectBlueBtn.addEventListener('click', () => handleTeamSelection('AZUL'));
        selectRedBtn.addEventListener('click', () => handleTeamSelection('ROJO'));

        // --- LÓGICA EN TIEMPO REAL (FIRESTORE) ---

        function listenToTotals() {
            const totalsDocRef = doc(db, `artifacts/${appId}/public/data/totals`, 'teams');
            onSnapshot(totalsDocRef, (docSnapshot) => {
                const data = docSnapshot.data() || { AZUL: 0, ROJO: 0 };
                const totalAzul = data.AZUL || 0;
                const totalRojo = data.ROJO || 0;

                const percentAzul = Math.min(100, (totalAzul / META) * 100).toFixed(1);
                const percentRojo = Math.min(100, (totalRojo / META) * 100).toFixed(1);

                progressBlue.style.width = `${percentAzul}%`;
                progressBlue.textContent = `${percentAzul}%`;
                totalBlueText.textContent = totalAzul.toLocaleString('es-ES');

                progressRed.style.width = `${percentRojo}%`;
                progressRed.textContent = `${percentRojo}%`;
                totalRedText.textContent = totalRojo.toLocaleString('es-ES');
            });
        }

        function listenToRegistros() {
            const registrosColRef = collection(db, `artifacts/${appId}/public/data/registros`);
            const q = query(registrosColRef, orderBy('createdAt', 'desc'));

            onSnapshot(q, (querySnapshot) => {
                registrosContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    registrosContainer.innerHTML = '<p class="text-gray-500 text-center">Aún no hay apuestas. ¡Sé el primero!</p>';
                }
                querySnapshot.forEach((doc) => {
                    const registro = doc.data();
                    const registroId = doc.id;
                    const el = createRegistroElement(registro, registroId);
                    registrosContainer.appendChild(el);
                });
            });
        }

        function createRegistroElement(registro, id) {
            const div = document.createElement('div');
            const teamClass = registro.team === 'AZUL' ? 'border-l-blue-500' : 'border-l-red-500';
            div.className = `registro-item p-3 bg-gray-900 rounded-md flex items-center justify-between ${teamClass}`;

            const userInfo = document.createElement('div');
            userInfo.innerHTML = `
                <p class="font-bold text-white">${registro.userName}</p>
                <p class="text-xs text-gray-400">Equipo ${registro.team}</p>
            `;

            const amountInfo = document.createElement('div');
            amountInfo.className = "text-right";
            
            const amountText = document.createElement('p');
            amountText.className = 'text-lg font-semibold text-green-400';
            amountText.textContent = `+${registro.amount.toLocaleString('es-ES')}`;
            amountInfo.appendChild(amountText);

            if (currentUser && registro.userId === currentUser.uid) {
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-red-500 transition-colors" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                    </svg>`;
                deleteBtn.onclick = () => showDeleteConfirmation(id, registro);
                amountInfo.appendChild(deleteBtn);
            }
            
            div.appendChild(userInfo);
            div.appendChild(amountInfo);
            return div;
        }

        // --- LÓGICA DE APUESTAS (AÑADIR Y QUITAR) ---

        saveButton.addEventListener('click', async () => {
            const amount = parseInt(amountInput.value);
            if (!currentUser || isNaN(amount) || amount <= 0) {
                alert('Ingresa una cantidad válida.');
                return;
            }

            saveButton.disabled = true;
            saveButton.textContent = 'Guardando...';

            try {
                // Añadir el registro
                const registrosColRef = collection(db, `artifacts/${appId}/public/data/registros`);
                await addDoc(registrosColRef, {
                    amount: amount,
                    team: currentUser.team,
                    userName: currentUser.name,
                    userId: currentUser.uid,
                    createdAt: serverTimestamp()
                });

                // Actualizar el total con una transacción
                const totalsDocRef = doc(db, `artifacts/${appId}/public/data/totals`, 'teams');
                await runTransaction(db, async (transaction) => {
                    const sfDoc = await transaction.get(totalsDocRef);
                    const currentTotal = sfDoc.exists() && sfDoc.data()[currentUser.team] ? sfDoc.data()[currentUser.team] : 0;
                    const newTotal = currentTotal + amount;
                    
                    if (!sfDoc.exists()) {
                         transaction.set(totalsDocRef, { [currentUser.team]: newTotal });
                    } else {
                         transaction.update(totalsDocRef, { [currentUser.team]: newTotal });
                    }
                });

                amountInput.value = '';
            } catch (e) {
                console.error("Error al guardar la apuesta: ", e);
                alert("Error al guardar la apuesta.");
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Aportar';
            }
        });

        function showDeleteConfirmation(docId, registro) {
            modalText.textContent = `¿Estás seguro de que quieres eliminar tu apuesta de ${registro.amount.toLocaleString('es-ES')}? Esta acción no se puede deshacer.`;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalBackdrop.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
            
            confirmDeleteBtn.onclick = () => handleDelete(docId, registro);
        }

        function hideDeleteConfirmation() {
            modalBackdrop.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        
        cancelDeleteBtn.addEventListener('click', hideDeleteConfirmation);
        modalBackdrop.addEventListener('click', hideDeleteConfirmation);

        async function handleDelete(docId, registro) {
             try {
                // Referencia al registro a eliminar
                const registroDocRef = doc(db, `artifacts/${appId}/public/data/registros`, docId);
                
                // Referencia al documento de totales
                const totalsDocRef = doc(db, `artifacts/${appId}/public/data/totals`, 'teams');
                
                await runTransaction(db, async (transaction) => {
                    const totalsDoc = await transaction.get(totalsDocRef);
                    if (!totalsDoc.exists()) {
                        throw "El documento de totales no existe.";
                    }
                    
                    const currentTotal = totalsDoc.data()[registro.team] || 0;
                    const newTotal = Math.max(0, currentTotal - registro.amount);
                    
                    transaction.update(totalsDocRef, { [registro.team]: newTotal });
                    transaction.delete(registroDocRef);
                });
                
            } catch (e) {
                console.error("Error al eliminar la apuesta: ", e);
                alert("No se pudo eliminar la apuesta.");
            } finally {
                hideDeleteConfirmation();
            }
        }

    </script>
</body>
</html>


