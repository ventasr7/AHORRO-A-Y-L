<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PrestamosPro - Gestor Local</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React y ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes scaleUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-scale-up { animation: scaleUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }

        @media print { 
            body * { visibility: hidden; } 
            #receipt-modal, #receipt-modal * { visibility: visible; } 
            #receipt-modal { 
                position: absolute; left: 0; top: 0; width: 100%; height: 100%; 
                background: white; z-index: 9999; display: flex !important; 
                align-items: center; justify-content: center;
            }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ICONOS ---
        const Icon = ({ p, size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{p}</svg>
        );
        const I = {
            Plus: <><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>,
            Dollar: <><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></>,
            User: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></>,
            Alert: <><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></>,
            Trash: <><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></>,
            X: <><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>,
            ArrowLeft: <><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></>,
            Printer: <><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></>,
            Lock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></>,
            PieChart: <><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></>,
            Check: <><polyline points="20 6 9 17 4 12"></polyline></>,
            TrendingUp: <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></>,
            Briefcase: <><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></>,
            Settings: <><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></>,
            Calculator: <><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="14"></line><line x1="8" y1="14" x2="8" y2="14"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="16" y1="18" x2="16" y2="18"></line><line x1="8" y1="18" x2="8" y2="18"></line><line x1="12" y1="18" x2="12" y2="18"></line></>
        };

        const App = () => {
            // --- ESTADO Y ALMACENAMIENTO LOCAL ---
            // Cargar datos de localStorage al iniciar
            const [loans, setLoans] = useState(() => {
                const saved = localStorage.getItem('myLoansApp_v1');
                return saved ? JSON.parse(saved) : [];
            });

            const [view, setView] = useState('dashboard');
            const [selectedLoan, setSelectedLoan] = useState(null);
            const [showReceipt, setShowReceipt] = useState(null);
            const [deletePinInput, setDeletePinInput] = useState('');
            const [itemToDelete, setItemToDelete] = useState(null);
            const [notification, setNotification] = useState(null);

            // Guardar en localStorage cada vez que cambie 'loans'
            useEffect(() => {
                localStorage.setItem('myLoansApp_v1', JSON.stringify(loans));
            }, [loans]);

            const showNotification = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            // --- LÓGICA DE NEGOCIO ---

            const handleCreateLoan = (loanData) => {
                const newLoan = {
                    id: Date.now().toString(), // ID único basado en fecha
                    clientName: loanData.clientName,
                    amount: parseFloat(loanData.principal),
                    quotaAmount: parseFloat(loanData.quotaAmount),
                    quotaCount: parseInt(loanData.quotaCount),
                    frequency: loanData.frequency,
                    totalToPay: parseFloat(loanData.totalToPay),
                    originalProfit: parseFloat(loanData.profit),
                    balance: parseFloat(loanData.totalToPay),
                    status: 'Activo',
                    createdAt: Date.now(),
                    dateString: new Date().toLocaleDateString(),
                    history: []
                };
                
                // Agregar al principio de la lista
                setLoans(prev => [newLoan, ...prev]);
                showNotification("¡Préstamo Guardado!");
                setView('dashboard');
            };

            const handleTransaction = (loanId, type, amountVal, note) => {
                const amount = parseFloat(amountVal);
                if (isNaN(amount) || amount <= 0) return;

                setLoans(prevLoans => {
                    return prevLoans.map(loan => {
                        if (loan.id === loanId) {
                            let newBalance = loan.balance;
                            if (type === 'payment') newBalance = Math.max(0, loan.balance - amount);
                            if (type === 'penalty') newBalance = loan.balance + amount;
                            
                            const newStatus = newBalance <= 1 ? 'Pagado' : 'Activo';
                            
                            const newTransaction = {
                                id: Date.now().toString(),
                                type, 
                                amount, 
                                note: note || (type === 'payment' ? 'Abono' : 'Mora'),
                                date: new Date().toLocaleString(),
                                balanceAfter: newBalance
                            };

                            const updatedLoan = {
                                ...loan,
                                balance: newBalance,
                                status: newStatus,
                                history: [newTransaction, ...(loan.history || [])]
                            };

                            // Si estamos viendo este préstamo, actualizamos el detalle también
                            if (selectedLoan && selectedLoan.id === loanId) {
                                setSelectedLoan(updatedLoan);
                                if (type === 'payment') {
                                    setShowReceipt({ loan: updatedLoan, transaction: newTransaction });
                                }
                            }
                            return updatedLoan;
                        }
                        return loan;
                    });
                });
            };

            const verifyAndDelete = () => {
                if (deletePinInput !== '203031') {
                    alert("PIN INCORRECTO");
                    return;
                }
                if (itemToDelete) {
                    setLoans(prev => prev.filter(l => l.id !== itemToDelete.id));
                    setView('dashboard');
                    setSelectedLoan(null);
                    showNotification("Registro eliminado");
                }
                setItemToDelete(null);
                setDeletePinInput('');
            };

            // --- VISTAS ---

            const Dashboard = () => {
                const active = loans.filter(l => l.status === 'Activo');
                const totalCalle = active.reduce((acc, curr) => acc + curr.balance, 0);
                const ganancia = loans.reduce((acc, curr) => acc + (curr.originalProfit || 0), 0);

                return (
                    <div className="animate-fade-in space-y-6 max-w-md mx-auto p-4 pt-6 pb-20">
                        <header className="flex justify-between items-center px-1">
                            <div>
                                <h1 className="text-3xl font-black text-gray-800 tracking-tighter">Prestamos<span className="text-blue-600">Pro</span></h1>
                                <p className="text-xs text-gray-400 font-semibold tracking-wide uppercase">Gestor Local</p>
                            </div>
                            <button onClick={() => setView('create')} className="bg-blue-600 text-white p-3 rounded-2xl shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all flex items-center gap-2">
                                <Icon p={I.Plus} /> <span className="font-bold hidden sm:inline">Nuevo</span>
                            </button>
                        </header>

                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-100 flex flex-col justify-between h-36 relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-4 opacity-5"><Icon p={I.Dollar} size={80}/></div>
                                <div className="flex justify-between items-start z-10">
                                    <div className="p-2 bg-blue-50 text-blue-600 rounded-xl"><Icon p={I.Dollar} size={20}/></div>
                                </div>
                                <div className="z-10">
                                    <p className="text-gray-400 text-[10px] font-bold uppercase mb-1 tracking-wider">Por Cobrar</p>
                                    <p className="text-2xl font-black text-gray-800">${totalCalle.toLocaleString()}</p>
                                </div>
                            </div>
                            <div className="bg-gray-900 p-5 rounded-[2rem] shadow-xl shadow-gray-300 flex flex-col justify-between h-36 text-white relative overflow-hidden">
                                <div className="absolute right-[-10px] top-[-10px] opacity-20"><Icon p={I.TrendingUp} size={100}/></div>
                                <div className="flex justify-between items-start relative z-10">
                                    <div className="p-2 bg-gray-700 rounded-xl"><Icon p={I.PieChart} size={20}/></div>
                                </div>
                                <div className="relative z-10">
                                    <p className="text-gray-400 text-[10px] font-bold uppercase mb-1 tracking-wider">Ganancia Total</p>
                                    <p className="text-2xl font-black text-green-400">+${ganancia.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h2 className="text-lg font-bold text-gray-700 mb-4 px-1">Cartera de Clientes</h2>
                            {active.length === 0 ? (
                                <div className="text-center py-16 bg-white rounded-3xl border border-dashed border-gray-200">
                                    <div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <Icon p={I.User} className="text-gray-300" size={30}/>
                                    </div>
                                    <p className="text-gray-400 font-medium">No hay préstamos activos</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {active.map(loan => (
                                        <div key={loan.id} onClick={() => {setSelectedLoan(loan); setView('detail')}} 
                                            className="bg-white p-5 rounded-3xl shadow-sm border border-gray-50 hover:shadow-md transition active:scale-[0.98] cursor-pointer group relative overflow-hidden">
                                            <div className="flex justify-between items-start mb-4 relative z-10">
                                                <div className="flex items-center gap-4">
                                                    <div className="w-12 h-12 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center font-black text-xl">
                                                        {loan.clientName.charAt(0).toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <h3 className="font-bold text-gray-800 text-lg leading-tight">{loan.clientName}</h3>
                                                        <p className="text-xs text-gray-400 font-medium">{loan.frequency}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className="font-bold text-blue-600 text-lg">${loan.balance.toLocaleString()}</p>
                                                    <p className="text-[10px] text-gray-400 uppercase font-bold tracking-wide">Pendiente</p>
                                                </div>
                                            </div>
                                            <div className="w-full bg-gray-100 rounded-full h-2 overflow-hidden relative z-10">
                                                <div className="bg-blue-600 h-full rounded-full" style={{width: `${((loan.totalToPay - loan.balance)/loan.totalToPay)*100}%`}}></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const CreateLoan = () => {
                const [form, setForm] = useState({ clientName: '', principal: '', paymentCapacity: '', interestRate: 20, frequency: 'Quincenal' });
                
                const calc = useMemo(() => {
                    const capital = parseFloat(form.principal) || 0;
                    const rate = parseFloat(form.interestRate) || 0;
                    const payCap = parseFloat(form.paymentCapacity) || 0;
                    
                    if (capital <= 0 || payCap <= 0) return null;
                    
                    const totalDebt = capital + (capital * (rate / 100));
                    const profit = totalDebt - capital;
                    const count = Math.ceil(totalDebt / payCap);
                    
                    return { totalToPay: totalDebt, profit, quotaCount: count, isValid: true };
                }, [form]);

                return (
                    <div className="animate-slide-up max-w-md mx-auto p-4 pt-6 pb-20">
                        <div className="flex items-center mb-6 px-1">
                            <button onClick={() => setView('dashboard')} className="p-3 mr-4 bg-white shadow-sm border border-gray-100 rounded-2xl text-gray-600 hover:bg-gray-50"><Icon p={I.ArrowLeft}/></button>
                            <h1 className="text-2xl font-black text-gray-800">Nuevo Préstamo</h1>
                        </div>

                        <div className="space-y-6">
                            <div className="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-100">
                                <label className="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2 block ml-1">Nombre del Cliente</label>
                                <input type="text" placeholder="Ej. Juan Pérez" autoFocus 
                                    className="w-full text-xl font-bold text-gray-800 placeholder-gray-300 outline-none border-b-2 border-gray-100 pb-2 focus:border-blue-500 transition-colors bg-transparent"
                                    value={form.clientName} onChange={e => setForm({...form, clientName: e.target.value})}/>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-100">
                                    <label className="text-[10px] font-bold text-blue-600 uppercase tracking-wide mb-2 block">Monto a Dar</label>
                                    <div className="flex items-center">
                                        <span className="text-gray-300 text-xl font-bold mr-1">$</span>
                                        <input type="number" placeholder="0" className="w-full text-2xl font-black text-gray-800 outline-none placeholder-gray-200 bg-transparent"
                                            value={form.principal} onChange={e => setForm({...form, principal: e.target.value})}/>
                                    </div>
                                </div>
                                <div className="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-100">
                                    <label className="text-[10px] font-bold text-green-600 uppercase tracking-wide mb-2 block">Pago {form.frequency}</label>
                                    <div className="flex items-center">
                                        <span className="text-gray-300 text-xl font-bold mr-1">$</span>
                                        <input type="number" placeholder="0" className="w-full text-2xl font-black text-gray-800 outline-none placeholder-gray-200 bg-transparent"
                                            value={form.paymentCapacity} onChange={e => setForm({...form, paymentCapacity: e.target.value})}/>
                                    </div>
                                </div>
                            </div>

                            <div className="flex gap-4 overflow-x-auto pb-2 scrollbar-hide">
                                <div className="bg-white px-5 py-4 rounded-2xl flex items-center gap-3 border border-gray-100 min-w-max shadow-sm">
                                    <Icon p={I.Settings} size={20} className="text-gray-300"/>
                                    <div>
                                        <label className="text-[10px] uppercase font-bold text-gray-400 block">Interés</label>
                                        <div className="flex items-center">
                                            <input type="number" value={form.interestRate} onChange={e => setForm({...form, interestRate: e.target.value})} className="bg-transparent font-bold text-gray-700 w-10 outline-none"/>
                                            <span className="text-gray-400 font-bold">%</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-white px-5 py-4 rounded-2xl flex items-center gap-3 border border-gray-100 min-w-max shadow-sm">
                                    <Icon p={I.Calculator} size={20} className="text-gray-300"/>
                                    <div>
                                        <label className="text-[10px] uppercase font-bold text-gray-400 block">Frecuencia</label>
                                        <select value={form.frequency} onChange={e => setForm({...form, frequency: e.target.value})} className="bg-transparent font-bold text-gray-700 outline-none text-sm pr-2">
                                            <option>Semanal</option><option>Quincenal</option><option>Mensual</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            {calc && form.clientName && (
                                <div className="bg-gray-900 rounded-[2rem] p-6 text-white shadow-2xl animate-scale-up relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-8 opacity-5"><Icon p={I.Dollar} size={150}/></div>
                                    <div className="relative z-10">
                                        <div className="flex justify-between items-end mb-6 border-b border-gray-700 pb-6">
                                            <div>
                                                <p className="text-gray-400 text-[10px] font-bold uppercase mb-1 tracking-widest">Total a Cobrar</p>
                                                <p className="text-4xl font-black tracking-tighter">${calc.totalToPay.toLocaleString()}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-gray-400 text-[10px] font-bold uppercase mb-1 tracking-widest">Ganancia</p>
                                                <p className="text-xl font-bold text-green-400">+${calc.profit.toLocaleString()}</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-4 text-sm text-gray-300 bg-gray-800 p-3 rounded-xl">
                                            <div className="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center font-bold text-white shadow-lg shadow-blue-900/50">
                                                {calc.quotaCount}
                                            </div>
                                            <p className="leading-tight">Pagos estimados de <br/><span className="text-white font-bold">${parseFloat(form.paymentCapacity).toLocaleString()}</span></p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <button disabled={!calc || !form.clientName} onClick={() => handleCreateLoan({...form, ...calc, quotaAmount: form.paymentCapacity})}
                                className={`w-full py-5 rounded-2xl font-bold text-lg shadow-xl transition-all transform active:scale-95 ${calc && form.clientName ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}>
                                Guardar Préstamo
                            </button>
                        </div>
                    </div>
                );
            };

            const LoanDetail = () => {
                if (!selectedLoan) return null;
                const [action, setAction] = useState(null);
                const [val, setVal] = useState('');
                const [note, setNote] = useState('');
                const progress = Math.min(100, ((selectedLoan.totalToPay - selectedLoan.balance)/selectedLoan.totalToPay)*100);

                const submitAction = (e) => {
                    e.preventDefault(); if(!val) return;
                    handleTransaction(selectedLoan.id, action, val, note);
                    setAction(null); setVal(''); setNote('');
                };

                return (
                    <div className="animate-slide-up pb-10 max-w-md mx-auto p-4 pt-6">
                        <div className="sticky top-0 bg-[#f3f4f6] z-20 py-2 flex justify-between items-center mb-2 px-1">
                            <button onClick={() => {setSelectedLoan(null); setView('dashboard')}} className="p-2 bg-white shadow-sm border border-gray-200 rounded-xl text-gray-600 flex items-center gap-2 font-bold text-sm hover:bg-gray-50"><Icon p={I.ArrowLeft} size={18}/> Volver</button>
                            <button onClick={() => setItemToDelete({type: 'loan', id: selectedLoan.id})} className="p-2 bg-white text-red-400 hover:bg-red-50 border border-gray-200 rounded-xl"><Icon p={I.Trash} size={20}/></button>
                        </div>

                        <div className="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 mb-4 relative overflow-hidden">
                            <div className="flex justify-between items-start mb-8">
                                <div>
                                    <h2 className="text-3xl font-black text-gray-800 leading-none mb-2">{selectedLoan.clientName}</h2>
                                    <span className="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg text-[10px] font-bold uppercase tracking-widest">{selectedLoan.frequency}</span>
                                </div>
                                <div className="text-right">
                                    <p className="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Deuda Total</p>
                                    <p className="text-xl font-bold text-gray-400 decoration-gray-300 line-through decoration-2">${selectedLoan.totalToPay.toLocaleString()}</p>
                                </div>
                            </div>
                            <div className="mb-4">
                                <p className="text-[10px] text-gray-400 uppercase font-bold mb-1 tracking-wider">Pendiente de Pago</p>
                                <p className="text-5xl font-black text-blue-600 tracking-tighter">${selectedLoan.balance.toLocaleString()}</p>
                            </div>
                            <div className="w-full bg-gray-100 h-4 rounded-full overflow-hidden mb-2">
                                <div className="bg-blue-600 h-full transition-all duration-1000 ease-out" style={{width: `${progress}%`}}></div>
                            </div>
                            <p className="text-right text-[10px] text-gray-400 font-bold uppercase">{Math.round(progress)}% Completado</p>
                        </div>

                         <div className="grid grid-cols-2 gap-4 mb-8">
                            <div className="bg-white p-4 rounded-3xl border border-gray-100 shadow-sm flex flex-col justify-center items-center text-center">
                                <div className="p-2 bg-gray-50 rounded-full text-gray-400 mb-2"><Icon p={I.Briefcase} size={20}/></div>
                                <p className="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-1">Prestado</p>
                                <p className="text-xl font-black text-gray-700">${selectedLoan.amount.toLocaleString()}</p>
                            </div>
                            <div className="bg-green-50 p-4 rounded-3xl border border-green-100 flex flex-col justify-center items-center text-center shadow-sm">
                                <div className="p-2 bg-white rounded-full text-green-500 mb-2"><Icon p={I.TrendingUp} size={20}/></div>
                                <p className="text-[10px] text-green-600 font-bold uppercase tracking-wider mb-1">Tu Ganancia</p>
                                <p className="text-xl font-black text-green-600">+${selectedLoan.originalProfit.toLocaleString()}</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4 mb-8">
                            <button onClick={() => setAction('payment')} className="bg-green-500 text-white p-5 rounded-[2rem] shadow-lg shadow-green-200 hover:bg-green-600 transition active:scale-95 flex flex-col items-center justify-center gap-2 group">
                                <div className="p-3 bg-white/20 rounded-full group-hover:bg-white/30 transition"><Icon p={I.Dollar} size={32} /></div>
                                <span className="font-bold text-lg">Abonar</span>
                            </button>
                            <button onClick={() => setAction('penalty')} className="bg-white border-2 border-red-50 text-red-500 p-5 rounded-[2rem] shadow-sm hover:border-red-100 transition active:scale-95 flex flex-col items-center justify-center gap-2">
                                <div className="p-3 bg-red-50 rounded-full"><Icon p={I.Alert} size={32}/></div>
                                <span className="font-bold text-lg">Mora</span>
                            </button>
                        </div>

                        {action && (
                            <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-md p-4 animate-fade-in">
                                <div className="bg-white w-full max-w-sm rounded-[2.5rem] p-6 shadow-2xl animate-scale-up">
                                    <div className="flex justify-between items-center mb-8">
                                        <h3 className="font-black text-2xl text-gray-800">{action === 'payment' ? 'Recibir Pago' : 'Aplicar Mora'}</h3>
                                        <button onClick={() => {setAction(null); setVal('')}} className="p-2 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200"><Icon p={I.X}/></button>
                                    </div>
                                    <form onSubmit={submitAction} className="space-y-4">
                                        {action === 'payment' && (
                                            <button type="button" onClick={() => setVal(selectedLoan.balance)} className="w-full py-3 bg-blue-50 text-blue-600 rounded-2xl font-bold text-sm border border-blue-100 hover:bg-blue-100 flex justify-between px-4 items-center mb-2 active:scale-95 transition">
                                                <span>Liquidar Deuda Total</span>
                                                <span className="bg-white px-2 py-1 rounded text-blue-700 shadow-sm">${selectedLoan.balance.toLocaleString()}</span>
                                            </button>
                                        )}
                                        <div>
                                            <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wide ml-1">Monto a Ingresar</label>
                                            <div className="relative mt-2">
                                                <span className="absolute left-5 top-5 text-gray-400 text-xl font-bold">$</span>
                                                <input type="number" autoFocus className="w-full pl-10 pr-5 py-5 bg-gray-50 rounded-[1.5rem] text-4xl font-black text-gray-800 outline-none focus:ring-2 focus:ring-blue-500 transition border border-transparent focus:bg-white" placeholder="0" value={val} onChange={e => setVal(e.target.value)}/>
                                            </div>
                                        </div>
                                        <input type="text" className="w-full p-5 bg-white border border-gray-200 rounded-2xl outline-none text-sm font-medium focus:border-blue-500" placeholder="Nota opcional (Ej. Adelanto)" value={note} onChange={e => setNote(e.target.value)}/>
                                        <button type="submit" className={`w-full py-5 rounded-2xl text-white font-bold text-xl shadow-xl active:scale-95 transition ${action === 'payment' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}`}>
                                            Confirmar
                                        </button>
                                    </form>
                                </div>
                            </div>
                        )}

                        <div className="space-y-4">
                            <h3 className="font-bold text-gray-400 uppercase text-[10px] tracking-widest ml-1 border-b border-gray-200 pb-2 mb-4">Historial de Movimientos</h3>
                            {selectedLoan.history?.length === 0 && <p className="text-center text-gray-400 italic py-10">Aún no hay pagos registrados</p>}
                            {selectedLoan.history?.map((h, i) => (
                                <div key={i} className="bg-white p-4 rounded-3xl shadow-sm border border-gray-50 flex justify-between items-center">
                                    <div className="flex items-center gap-4">
                                        <div className={`w-12 h-12 rounded-2xl flex items-center justify-center ${h.type === 'payment' ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-500'}`}>
                                            {h.type === 'payment' ? <Icon p={I.Dollar} size={24}/> : <Icon p={I.Alert} size={24}/>}
                                        </div>
                                        <div>
                                            <p className="font-bold text-gray-700 leading-tight">{h.note}</p>
                                            <p className="text-[10px] text-gray-400 font-medium uppercase mt-1">{h.date}</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className={`font-black text-lg ${h.type === 'payment' ? 'text-green-600' : 'text-red-500'}`}>
                                            {h.type === 'payment' ? '-' : '+'}${h.amount.toLocaleString()}
                                        </p>
                                        {h.type === 'payment' && <button onClick={() => setShowReceipt({loan: selectedLoan, transaction: h})} className="text-blue-500 text-[10px] font-bold uppercase tracking-wide bg-blue-50 px-3 py-1 rounded-full hover:bg-blue-100 transition mt-1">Ver Recibo</button>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const NotificationToast = () => {
                if(!notification) return null;
                return <div className="fixed top-5 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-4 rounded-full shadow-2xl z-50 flex items-center gap-3 animate-slide-up"><Icon p={I.Check} size={20} className="text-green-400"/><span className="font-bold text-sm">{notification}</span></div>;
            }

            const PinModal = () => {
                if(!itemToDelete) return null;
                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-md p-4">
                        <div className="bg-white p-8 rounded-[2.5rem] w-full max-w-xs shadow-2xl animate-scale-up">
                            <div className="text-center mb-6">
                                <div className="bg-red-50 text-red-500 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Icon p={I.Lock} size={32}/></div>
                                <h3 className="font-black text-gray-800 text-xl">Zona Segura</h3>
                                <p className="text-xs text-gray-500 mt-2 font-medium">Ingresa el PIN maestro para eliminar</p>
                            </div>
                            <input type="password" autoFocus className="w-full text-center text-4xl tracking-[0.5em] font-black border-2 border-gray-100 rounded-2xl p-4 mb-6 outline-none focus:border-red-500 transition-colors text-gray-700 placeholder-gray-200" placeholder="••••" value={deletePinInput} onChange={e => setDeletePinInput(e.target.value)}/>
                            <div className="flex gap-3">
                                <button onClick={() => {setItemToDelete(null); setDeletePinInput('')}} className="flex-1 py-4 text-gray-500 font-bold hover:bg-gray-50 rounded-2xl transition">Cancelar</button>
                                <button onClick={verifyAndDelete} className="flex-1 py-4 bg-red-600 text-white rounded-2xl font-bold shadow-lg hover:bg-red-700 transition">Eliminar</button>
                            </div>
                        </div>
                    </div>
                );
            };

            const Receipt = () => {
                if(!showReceipt) return null;
                const { loan, transaction } = showReceipt;
                return (
                    <div id="receipt-modal" className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm">
                        <div className="bg-white w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl relative animate-scale-up">
                            <button onClick={() => setShowReceipt(null)} className="absolute top-4 right-4 p-2 bg-white/20 hover:bg-white/40 rounded-full text-white z-10 transition no-print"><Icon p={I.X} size={24}/></button>
                            <div className="bg-blue-600 p-10 text-white text-center relative overflow-hidden">
                                <div className="absolute -top-10 -left-10 w-40 h-40 bg-white opacity-10 rounded-full"></div>
                                <h2 className="text-3xl font-black uppercase tracking-widest mb-2 relative z-10">Recibo</h2>
                                <p className="text-sm opacity-80 font-medium relative z-10">{transaction.date}</p>
                            </div>
                            <div className="p-8">
                                <div className="text-center mb-8">
                                    <p className="text-gray-400 text-[10px] uppercase font-bold tracking-widest mb-2">Cliente</p>
                                    <h3 className="text-3xl font-black text-gray-800">{loan.clientName}</h3>
                                </div>
                                <div className="bg-gray-50 border-2 border-dashed border-gray-200 p-6 rounded-2xl mb-6">
                                    <div className="flex justify-between mb-4">
                                        <span className="text-gray-500 text-sm font-bold uppercase tracking-wide">Abono</span>
                                        <span className="text-3xl font-black text-gray-800">${transaction.amount.toLocaleString()}</span>
                                    </div>
                                    <div className="w-full border-t border-gray-200 my-4"></div>
                                    <div className="flex justify-between text-sm items-center">
                                        <span className="text-gray-500 font-bold uppercase tracking-wide">Deuda Restante</span>
                                        <span className="font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-lg">${transaction.balanceAfter.toLocaleString()}</span>
                                    </div>
                                </div>
                                <button onClick={() => window.print()} className="w-full py-5 bg-gray-900 text-white rounded-2xl font-bold shadow-xl hover:bg-black transition flex justify-center items-center gap-2 no-print">
                                    <Icon p={I.Printer} size={20}/> Imprimir Comprobante
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-[#f3f4f6]">
                    {view === 'dashboard' && <Dashboard/>}
                    {view === 'create' && <CreateLoan/>}
                    {view === 'detail' && <LoanDetail/>}
                    <PinModal/>
                    <Receipt/>
                    <NotificationToast/>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


